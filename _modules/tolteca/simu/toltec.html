
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tolteca.simu.toltec &#8212; tolteca v0.1.dev323+g1c6dc6b</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">TolTECA</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">tolteca v0.1.dev323+g1c6dc6b</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >Module code</a> &#187;</li>
      <li><a href="../simu.html" accesskey="U">tolteca.simu</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tolteca.simu.toltec</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.functional_models</span> <span class="kn">import</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coord</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">celestial_frame_to_wcs</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates.erfa_astrom</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">erfa_astrom</span><span class="p">,</span> <span class="n">ErfaAstromInterpolator</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">default_cosmology</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy.utils.decorators</span> <span class="kn">import</span> <span class="n">classproperty</span>

<span class="kn">from</span> <span class="nn">gwcs</span> <span class="kn">import</span> <span class="n">coordinate_frames</span> <span class="k">as</span> <span class="n">cf</span>

<span class="kn">from</span> <span class="nn">kidsproc.kidsmodel</span> <span class="kn">import</span> <span class="n">ReadoutGainWithLinTrend</span>
<span class="kn">from</span> <span class="nn">kidsproc.kidsmodel.simulator</span> <span class="kn">import</span> <span class="n">KidsSimulator</span>
<span class="kn">from</span> <span class="nn">tollan.utils.log</span> <span class="kn">import</span> <span class="n">timeit</span><span class="p">,</span> <span class="n">get_logger</span>

<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">_Model</span><span class="p">,</span>
        <span class="n">ProjModel</span><span class="p">,</span> <span class="n">_get_skyoffset_frame</span><span class="p">,</span>
        <span class="n">SourceImageModel</span><span class="p">,</span> <span class="n">SourceCatalogModel</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="n">resolve_sky_map_ref_frame</span> <span class="k">as</span> <span class="n">_resolve_sky_map_ref_frame</span>
<span class="kn">from</span> <span class="nn">...utils</span> <span class="kn">import</span> <span class="n">get_pkg_data_path</span>
<span class="kn">from</span> <span class="nn">...common.toltec</span> <span class="kn">import</span> <span class="n">info</span> <span class="k">as</span> <span class="n">toltec_info</span>  <span class="c1"># noqa: F401</span>
<span class="kn">from</span> <span class="nn">.lmt</span> <span class="kn">import</span> <span class="n">info</span> <span class="k">as</span> <span class="n">site_info</span>
<span class="kn">from</span> <span class="nn">.lmt</span> <span class="kn">import</span> <span class="n">get_lmt_atm_models</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;toltec_info&#39;</span><span class="p">,</span>
        <span class="s1">&#39;site_info&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_default_passbands&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_default_cosmology&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_observer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ArrayProjModel&#39;</span><span class="p">,</span>
        <span class="p">]</span>


<div class="viewcode-block" id="get_default_passbands"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.get_default_passbands.html#tolteca.simu.toltec.get_default_passbands">[docs]</a><span class="k">def</span> <span class="nf">get_default_passbands</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the default passband tables as a dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">...cal.toltec</span> <span class="kn">import</span> <span class="n">ToltecPassband</span>
    <span class="n">calobj</span> <span class="o">=</span> <span class="n">ToltecPassband</span><span class="o">.</span><span class="n">from_indexfile</span><span class="p">(</span><span class="n">get_pkg_data_path</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
        <span class="s1">&#39;cal/toltec_passband/index.yaml&#39;</span>
        <span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">calobj</span><span class="o">.</span><span class="n">array_names</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">calobj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">array_name</span><span class="o">=</span><span class="n">array_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_default_cosmology"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.get_default_cosmology.html#tolteca.simu.toltec.get_default_cosmology">[docs]</a><span class="k">def</span> <span class="nf">get_default_cosmology</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the default cosmology.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">default_cosmology</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_observer"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.get_observer.html#tolteca.simu.toltec.get_observer">[docs]</a><span class="k">def</span> <span class="nf">get_observer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the `astroplan.Observer` object for LMT TolTEC.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">site_info</span><span class="p">[</span><span class="s1">&#39;observer&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="ArrayProjModel"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.ArrayProjModel.html#tolteca.simu.toltec.ArrayProjModel">[docs]</a><span class="k">class</span> <span class="nc">ArrayProjModel</span><span class="p">(</span><span class="n">ProjModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A model that transforms the TolTEC detector locations per array to</span>
<span class="sd">    a common instrument coordinate system.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO we need a unified management for such facts, in the package</span>
    <span class="c1"># level</span>
    <span class="n">toltec_instru_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;a1100&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">:</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">},</span>
            <span class="s1">&#39;a1400&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">:</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">},</span>
            <span class="s1">&#39;a2000&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">:</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">},</span>
            <span class="s1">&#39;toltec&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">:</span> <span class="mf">90.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="s1">&#39;array_names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;a2000&#39;</span><span class="p">),</span>
                <span class="c1"># &#39;plate_scale&#39;: ()</span>
                <span class="s1">&#39;fov_diam&#39;</span><span class="p">:</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="s1">&#39;array_diam&#39;</span><span class="p">:</span> <span class="mf">127049.101</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span>  <span class="c1"># from a1100 design spec.</span>
                <span class="p">},</span>
            <span class="p">}</span>
    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span>
                <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
                <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">))</span>
    <span class="n">output_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;toltec&#39;</span><span class="p">,</span>
                <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;az_offset&quot;</span><span class="p">,</span> <span class="s2">&quot;alt_offset&quot;</span><span class="p">),</span>
                <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_frame</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_proj&#39;</span>

    <span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toltec_instru_spec</span>

        <span class="c1"># The mirror put array on the perspective of an observer.</span>
        <span class="n">m_mirr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">plate_scale</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;fov_diam&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;array_diam&#39;</span><span class="p">]</span>

        <span class="n">m_projs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_names</span><span class="p">:</span>

            <span class="c1"># this rot and scale put the arrays on the on the sky in Altaz</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">]</span> <span class="o">-</span>
                    <span class="n">spec</span><span class="p">[</span><span class="n">array_name</span><span class="p">][</span><span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">m_rot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Rotation2D</span><span class="o">.</span><span class="n">_compute_matrix</span><span class="p">(</span>
                    <span class="n">angle</span><span class="o">=</span><span class="n">rot</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">))</span>

            <span class="n">m_projs</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AffineTransformation2D</span><span class="p">(</span>
                <span class="p">(</span><span class="n">m_rot</span> <span class="o">@</span> <span class="n">m_mirr</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span>
                <span class="n">translation</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Multiply</span><span class="p">(</span><span class="n">plate_scale</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Multiply</span><span class="p">(</span><span class="n">plate_scale</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m_projs</span> <span class="o">=</span> <span class="n">m_projs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;axes_names&#39;</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_frame</span><span class="o">.</span><span class="n">axes_names</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ArrayProjModel.evaluate"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.ArrayProjModel.html#tolteca.simu.toltec.ArrayProjModel.evaluate">[docs]</a>    <span class="nd">@timeit</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">out_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">x_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_unit</span>
        <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_unit</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_names</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">array_name</span> <span class="o">==</span> <span class="n">n</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_projs</span><span class="p">[</span><span class="n">n</span><span class="p">](</span><span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">x_out</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out_unit</span><span class="p">)</span>
            <span class="n">y_out</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out_unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toltec_instru_spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;array_names&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="ArrayProjModel.prepare_inputs"><a class="viewcode-back" href="../../../api/tolteca.simu.toltec.ArrayProjModel.html#tolteca.simu.toltec.ArrayProjModel.prepare_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this is necessary to handle the array_name inputs</span>
        <span class="n">array_name_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span>
                <span class="n">array_name_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">array_name</span><span class="p">)[</span><span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span></div></div>


<span class="k">class</span> <span class="nc">ArrayPolarizedProjModel</span><span class="p">(</span><span class="n">ArrayProjModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A model that transforms the TolTEC detector locations per array to</span>
<span class="sd">    a common instrument coordinate system.</span>

<span class="sd">    This model is different from ArrayProjModel that it also projects</span>
<span class="sd">    the polarization angles of each detector, taking into account</span>
<span class="sd">    the parity caused by the mirror reflection.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_pa_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CoordinateFrame</span><span class="p">(</span>
                    <span class="n">naxes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">axes_type</span><span class="o">=</span><span class="s1">&#39;SPATIAL&#39;</span><span class="p">,</span>
                    <span class="n">axes_order</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pa&quot;</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;polarimetry&#39;</span>
                    <span class="p">)</span>
    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">(</span>
            <span class="n">frames</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ArrayProjModel</span><span class="o">.</span><span class="n">input_frame</span><span class="p">,</span>
                <span class="n">_pa_frame</span>
                <span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">ArrayProjModel</span><span class="o">.</span><span class="n">input_frame</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_polarimetry&#39;</span>
            <span class="p">)</span>
    <span class="n">output_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">CompositeFrame</span><span class="p">(</span>
            <span class="n">frames</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ArrayProjModel</span><span class="o">.</span><span class="n">output_frame</span><span class="p">,</span>
                <span class="n">_pa_frame</span>
                <span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">ArrayProjModel</span><span class="o">.</span><span class="n">input_frame</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_polarimetry&#39;</span>
            <span class="p">)</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_frame</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_proj&#39;</span>

    <span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="nd">@timeit</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pa</span><span class="p">):</span>
        <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toltec_instru_spec</span>
        <span class="n">out_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>

        <span class="n">pa_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_unit</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_names</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">array_name</span> <span class="o">==</span> <span class="n">n</span>
            <span class="n">pa_out</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pa</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">spec</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;rot_from_a1100&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">,</span> <span class="n">pa_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toltec_instru_spec</span><span class="p">[</span><span class="s1">&#39;toltec&#39;</span><span class="p">][</span><span class="s1">&#39;array_names&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this is necessary to handle the array_name inputs</span>
        <span class="n">array_name_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span>
                <span class="n">array_name_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">array_name</span><span class="p">)[</span><span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span>


<span class="k">class</span> <span class="nc">SkyProjModel</span><span class="p">(</span><span class="n">ProjModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A sky projection model for TolTEC.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_coord: 2-tuple of `astropy.units.Quantity`</span>
<span class="sd">        The coordinate of the TolTEC frame origin on the sky.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">ArrayProjModel</span><span class="o">.</span><span class="n">output_frame</span>
    <span class="n">output_frame</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">Frame2D</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sky&#39;</span><span class="p">,</span>
                <span class="n">axes_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">),</span>
                <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_frame</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_proj&#39;</span>

    <span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">crval0</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">180.</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">output_frame</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">crval1</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">output_frame</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mjd_obs</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="mf">2000.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>

    <span class="n">observer</span> <span class="o">=</span> <span class="n">get_observer</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ref_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">evaluate_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ref_coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;crval0&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s1">&#39;crval1&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;ref_coord cannot be specified along with crvals&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_coord</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">):</span>
                <span class="n">_ref_coord</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ref_coord</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                        <span class="n">ref_coord</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crval0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ref_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crval1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ref_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_ref_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crval_frame</span> <span class="o">=</span> <span class="n">ref_coord</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">if</span> <span class="n">time_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mjd_obs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;time_obs cannot be specified along with mjd_obs&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mjd_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">mjd</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span> <span class="o">=</span> <span class="n">evaluate_frame</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_native_frame</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mjd_obs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">altaz</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_native_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_native_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd_obs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_projected_frame</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">crval0</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval_frame</span><span class="p">,</span>
            <span class="n">mjd_obs</span><span class="p">,</span> <span class="n">also_return_native_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_native_frame</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">)</span>
        <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span>
                <span class="n">crval0</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">crval1</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="n">frame</span><span class="o">=</span><span class="n">crval_frame</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ref_frame</span><span class="p">)</span>
        <span class="n">ref_offset_frame</span> <span class="o">=</span> <span class="n">_get_skyoffset_frame</span><span class="p">(</span><span class="n">ref_coord</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">also_return_native_frame</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ref_offset_frame</span><span class="p">,</span> <span class="n">ref_frame</span>
        <span class="k">return</span> <span class="n">ref_offset_frame</span>

    <span class="nd">@timeit</span>
    <span class="k">def</span> <span class="nf">get_projected_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_frame</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crval0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crval1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crval_frame</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mjd_obs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@timeit</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_interp_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span>
        <span class="n">old_evaluate_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="k">if</span> <span class="n">eval_interp_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">mjd_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd_obs</span><span class="o">.</span><span class="n">quantity</span>
            <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crval0</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crval1</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crval_frame</span><span class="p">)</span>

            <span class="c1"># make a subset of crvals for fast evaluate</span>
            <span class="c1"># we need to make sure mjd_obs is sorted before hand</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mjd_obs has to be sorted ascending.&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">-</span> <span class="n">mjd_obs</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">eval_interp_len</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluate </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">)</span><span class="si">}</span><span class="s2"> times&quot;</span><span class="p">)</span>
            <span class="n">ref_coord_s</span> <span class="o">=</span> <span class="n">ref_coord</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">mjd_obs_s</span> <span class="o">=</span> <span class="n">mjd_obs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">mdl_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                    <span class="n">ref_coord</span><span class="o">=</span><span class="n">ref_coord_s</span><span class="p">,</span> <span class="n">mjd_obs</span><span class="o">=</span><span class="n">mjd_obs_s</span><span class="p">,</span>
                    <span class="n">evaluate_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span><span class="p">)</span>
            <span class="n">lon_s</span><span class="p">,</span> <span class="n">lat_s</span> <span class="o">=</span> <span class="n">mdl_s</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1"># now build the spline interp</span>
            <span class="n">lon_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">mjd_obs_s</span><span class="p">,</span> <span class="n">lon_s</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">lat_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">mjd_obs_s</span><span class="p">,</span> <span class="n">lat_s</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon_interp</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat_interp</span><span class="p">(</span><span class="n">mjd_obs</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span> <span class="o">=</span> <span class="n">old_evaluate_frame</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@timeit</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">crval0</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">mjd_obs</span><span class="p">):</span>

        <span class="n">ref_offset_frame</span><span class="p">,</span> <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_frame</span><span class="p">(</span>
                <span class="n">crval0</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crval_frame</span><span class="p">,</span>
                <span class="n">mjd_obs</span><span class="p">,</span> <span class="n">also_return_native_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">det_coords_offset</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">ref_offset_frame</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;transform det coords to altaz&quot;</span><span class="p">):</span>
            <span class="n">det_coords</span> <span class="o">=</span> <span class="n">det_coords_offset</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ref_frame</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_frame</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;native&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">det_coords</span><span class="o">.</span><span class="n">az</span><span class="p">,</span> <span class="n">det_coords</span><span class="o">.</span><span class="n">alt</span>
        <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transform det coords to </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">det_coords</span> <span class="o">=</span> <span class="n">det_coords</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">det_coords</span><span class="o">.</span><span class="n">get_representation_component_names</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">det_coords</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">det_coords</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">mpl_axes_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">celestial_frame_to_wcs</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">ICRS</span><span class="p">())</span>
        <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crval0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crval1</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crval_frame</span>
                <span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ref_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                <span class="n">ref_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">mpl_axes_params</span><span class="p">(),</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BeamModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A model that describes the TolTEC beam shapes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">beam_props</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;array_names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;a2000&#39;</span><span class="p">),</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">,</span>
            <span class="s1">&#39;x_fwhm_a1100&#39;</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
            <span class="s1">&#39;y_fwhm_a1100&#39;</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
            <span class="s1">&#39;a1100&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;wl_center&#39;</span><span class="p">:</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
                <span class="p">},</span>
            <span class="s1">&#39;a1400&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;wl_center&#39;</span><span class="p">:</span> <span class="mf">1.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
                <span class="p">},</span>
            <span class="s1">&#39;a2000&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;wl_center&#39;</span><span class="p">:</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
                <span class="p">},</span>
            <span class="p">}</span>
    <span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">beam_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_props</span>
        <span class="n">m_beams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;array_names&#39;</span><span class="p">]:</span>
            <span class="n">x_fwhm</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;x_fwhm_a1100&#39;</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="n">array_name</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">]</span> <span class="o">/</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">])</span>
            <span class="n">y_fwhm</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;y_fwhm_a1100&#39;</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="n">array_name</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">]</span> <span class="o">/</span>
                    <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">])</span>
            <span class="n">x_stddev</span> <span class="o">=</span> <span class="n">x_fwhm</span> <span class="o">/</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span>
            <span class="n">y_stddev</span> <span class="o">=</span> <span class="n">y_fwhm</span> <span class="o">/</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span>
            <span class="n">beam_area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x_stddev</span> <span class="o">*</span> <span class="n">y_stddev</span>
            <span class="n">m_beams</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">](</span>
                    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">beam_area</span><span class="p">,</span>
                    <span class="n">x_mean</span><span class="o">=</span><span class="mf">0.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
                    <span class="n">y_mean</span><span class="o">=</span><span class="mf">0.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
                    <span class="n">x_stddev</span><span class="o">=</span><span class="n">x_stddev</span><span class="p">,</span>
                    <span class="n">y_stddev</span><span class="o">=</span><span class="n">y_stddev</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m_beams</span> <span class="o">=</span> <span class="n">m_beams</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;array_name&#39;</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">m_beams</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">m_beams</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">out_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_beams</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">out_unit</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_props</span><span class="p">[</span><span class="s1">&#39;array_names&#39;</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">array_name</span> <span class="o">==</span> <span class="n">n</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_beams</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">bounding_box</span>
            <span class="n">x_m</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
            <span class="n">y_m</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_m</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_m</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_m</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_m</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">m_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">out_unit</span>
            <span class="n">m_out</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">x_m</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">y_m</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_out</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out_unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_beams</span>

    <span class="k">def</span> <span class="nf">prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this is necessary to handle the array_name inputs</span>
        <span class="n">array_name_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array_name</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span>
                <span class="n">array_name_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">array_name</span><span class="p">)[</span><span class="n">inputs_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">inputs_new</span><span class="p">,</span> <span class="n">broadcasts</span>


<span class="k">class</span> <span class="nc">ArrayLoadingModel</span><span class="p">(</span><span class="n">_Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A model of the LMT optical loading at the TolTEC arrays.</span>

<span class="sd">    This is based on the Mapping-speed-caluator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO allow overwriting these per instance.</span>
    <span class="n">_toltec_passbands</span> <span class="o">=</span> <span class="n">get_default_passbands</span><span class="p">()</span>
    <span class="n">_cosmo</span> <span class="o">=</span> <span class="n">get_default_cosmology</span><span class="p">()</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

    <span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">atm_model_name</span><span class="o">=</span><span class="s1">&#39;am_q50&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s1">_loading&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;nep&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_array_name</span> <span class="o">=</span> <span class="n">array_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toltec_passbands</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_passband</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="c1"># check the f step, they shall be uniform</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;invalid passband format, frequency grid has to be uniform&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_throughput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_passband</span><span class="p">[</span><span class="s1">&#39;throughput&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atm_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atm_tx_model</span> <span class="o">=</span> <span class="n">get_lmt_atm_models</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">atm_model_name</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">_internal_params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lower level instrument parameters for LMT/TolTEC.</span>

<span class="sd">        Note that all these values does not take into account the</span>
<span class="sd">        passbands, and are frequency independent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO merge this to the instrument fact yaml file?</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;det_optical_efficiency&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;det_noise_factor&#39;</span><span class="p">:</span> <span class="mf">0.334</span><span class="p">,</span>
                <span class="s1">&#39;horn_aperture_efficiency&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>
                <span class="s1">&#39;tel_diameter&#39;</span><span class="p">:</span> <span class="mf">48.</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="s1">&#39;tel_surface_rms&#39;</span><span class="p">:</span> <span class="mf">76.</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span>
                <span class="s1">&#39;tel_emissivity&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span>
                <span class="s1">&#39;T_coldbox&#39;</span><span class="p">:</span> <span class="mf">5.75</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                <span class="s1">&#39;T_tel&#39;</span><span class="p">:</span> <span class="mf">273.</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>  <span class="c1"># telescope ambient temperature</span>
                <span class="s1">&#39;T_coupling_optics&#39;</span><span class="p">:</span> <span class="mf">290.</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>  <span class="c1"># coupling optics</span>
                <span class="p">}</span>
        <span class="c1"># derived values</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;tel_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;tel_diameter&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1"># effective optics temperature due to telescope and the coupling</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_warm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">p</span><span class="p">[</span><span class="s1">&#39;tel_emissivity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_tel&#39;</span><span class="p">]</span>
                <span class="c1"># TODO add documents for the numbers here</span>
                <span class="o">+</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_coupling_optics&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span>
                <span class="p">)</span>
        <span class="c1"># cold efficiency is the efficiency inside the cold box.</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cold_efficiency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">p</span><span class="p">[</span><span class="s1">&#39;det_optical_efficiency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;horn_aperture_efficiency&#39;</span><span class="p">])</span>
        <span class="c1"># effetive temperature at detectors for warm components through</span>
        <span class="c1"># the cold box</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_det_warm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_warm&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cold_efficiency&#39;</span><span class="p">])</span>
        <span class="c1"># effetive temperature at detectors for cold box</span>
        <span class="c1"># note that the &quot;horn aperture efficiency&quot; is actually the</span>
        <span class="c1"># internal system aperture efficiency since it includes the</span>
        <span class="c1"># truncation of the lyot stop and the loss to the cold optics</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_det_coldbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">p</span><span class="p">[</span><span class="s1">&#39;T_coldbox&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;det_optical_efficiency&#39;</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;horn_aperture_efficiency&#39;</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_tel_primary_surface_optical_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The telescope optical efficiency due to RMS of the</span>
<span class="sd">        primary surface over the passband.</span>

<span class="sd">        This is just the Ruze formula.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tel_surface_rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;tel_surface_rms&#39;</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">tel_surface_rms</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">f</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_system_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The overall system efficiency over the passband.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tel_primary_surface_optical_efficiency</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;cold_efficiency&#39;</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_throughput</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_wsum</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return weighted sum of some quantity.</span>

<span class="sd">        q : `astropy.units.Quantity`</span>
<span class="sd">            The quantity.</span>

<span class="sd">        w : float</span>
<span class="sd">            The wegith.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;weight has to be 1d&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_T_atm</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span>
            <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the atmosphere temperature.</span>

<span class="sd">        This is the &quot;true&quot; temperature without taking into account the system</span>
<span class="sd">        efficiency.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alt : `astropy.units.Quantity`</span>
<span class="sd">            The altitude.</span>
<span class="sd">        return_avg : bool, optional</span>
<span class="sd">            If True, return the weighted sum over the passband instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atm_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atm_model</span>
        <span class="c1"># here we put the alt on the first axis for easier reduction on f.</span>
        <span class="n">T_atm</span> <span class="o">=</span> <span class="n">atm_model</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">return_avg</span><span class="p">:</span>
            <span class="n">T_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wsum</span><span class="p">(</span><span class="n">T_atm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_throughput</span><span class="p">)</span>
        <span class="n">T_atm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">T_atm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T_atm</span>

    <span class="k">def</span> <span class="nf">_get_tx_atm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the atmosphere transmission.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alt : `astropy.units.Quantity`</span>
<span class="sd">            The altitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atm_tx_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atm_tx_model</span>
        <span class="c1"># here we put the alt on the first axis for easier reduction on f.</span>
        <span class="n">tx_atm</span> <span class="o">=</span> <span class="n">atm_tx_model</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">tx_atm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tx_atm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx_atm</span>

    <span class="k">def</span> <span class="nf">_get_T</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span>
            <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the effective temperature at altitude `alt`, as seen</span>
<span class="sd">        by the cryostat.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alt : `astropy.units.Quantity`</span>
<span class="sd">            The altitude.</span>
<span class="sd">        return_avg : bool, optional</span>
<span class="sd">            If True, return the weighted sum over the passband instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_T_atm</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># add the telescope warm component temps</span>
        <span class="n">T_tot</span> <span class="o">=</span> <span class="n">T_atm</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;T_warm&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_avg</span><span class="p">:</span>
            <span class="n">T_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wsum</span><span class="p">(</span><span class="n">T_tot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_efficiency</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T_tot</span>

    <span class="k">def</span> <span class="nf">_get_T_det</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span>
            <span class="n">return_avg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the effective temperature seen by the detectors</span>
<span class="sd">        at altitude `alt`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alt : `astropy.units.Quantity`</span>
<span class="sd">            The altitude.</span>
<span class="sd">        return_avg : bool, optional</span>
<span class="sd">            If True, return the weighted sum over the passband instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_T_atm</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># TODO why no telescope efficiency term?</span>
        <span class="n">T_det</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">T_atm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;cold_efficiency&#39;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;T_det_warm&#39;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;T_det_coldbox&#39;</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_throughput</span>
        <span class="k">if</span> <span class="n">return_avg</span><span class="p">:</span>
            <span class="c1"># note this is different from the Detector.py in that</span>
            <span class="c1"># does not mistakenly (?) average over the passband again</span>
            <span class="n">T_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_det</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T_det</span>

    <span class="k">def</span> <span class="nf">_T_to_dP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Rayleigh-Jeans power for the passband frequency bins.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T : `astropy.units.Quantity`</span>
<span class="sd">            The temperature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># power from RJ source in frequency bin df</span>
        <span class="c1"># TODO this can be done this way because we ensured df is contant</span>
        <span class="c1"># over the passband.</span>
        <span class="c1"># we may change this to trapz to allow arbitrary grid?</span>
        <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="k">def</span> <span class="nf">_T_to_dnep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the photon noise equivalent power in W / sqrt(Hz) for</span>
<span class="sd">        the passband frequency bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
        <span class="n">dP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_to_dP</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="n">shot</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">df</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dP</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">shot</span> <span class="o">+</span> <span class="n">wave</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_T_to_dnet_cmb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">tx_atm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the noise equivalent CMB temperature in K / sqrt(Hz) for</span>
<span class="sd">        the passband frequency bins.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T : `astropy.units.Quantity`</span>
<span class="sd">            The temperature.</span>
<span class="sd">        tx_atm : array</span>
<span class="sd">            The atmosphere transmission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
        <span class="n">Tcmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">Tcmb</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">dnep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_to_dnep</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">Tcmb</span><span class="p">)</span>
        <span class="n">net_integrand</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">k_B</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">**</span> <span class="mf">2.</span>
                <span class="p">)</span>
        <span class="n">dnet</span> <span class="o">=</span> <span class="n">dnep</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_efficiency</span>
                <span class="o">*</span> <span class="n">net_integrand</span>
                <span class="o">*</span> <span class="n">df</span><span class="p">)</span>
        <span class="c1"># scale by the atmosphere transmission so this is comparable</span>
        <span class="c1"># to astronomical sources.</span>
        <span class="k">return</span> <span class="n">dnet</span> <span class="o">/</span> <span class="n">tx_atm</span>

    <span class="k">def</span> <span class="nf">_dnep_to_dnefd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dnep</span><span class="p">,</span> <span class="n">tx_atm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the noise equivalent flux density in Jy / sqrt(Hz) for</span>
<span class="sd">        the passband frequency bins.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T : `astropy.units.Quantity`</span>
<span class="sd">            The temperature.</span>
<span class="sd">        tx_atm : array</span>
<span class="sd">            The atmosphere transmission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;tel_area&#39;</span><span class="p">]</span>
        <span class="c1"># TODO Z. Ma: I combined the sqrt(2) term. need to check the eqn here.</span>
        <span class="n">dnefd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dnep</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">df</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_efficiency</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
        <span class="c1"># scale by the atmosphere transmission so this is comparable</span>
        <span class="c1"># to astronomical sources.</span>
        <span class="k">return</span> <span class="n">dnefd</span> <span class="o">/</span> <span class="n">tx_atm</span>  <span class="c1"># Jy / sqrt(Hz)</span>

    <span class="k">def</span> <span class="nf">_get_P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the detector power loading at altitude `alt`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T_det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_T_det</span><span class="p">(</span><span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_to_dP</span><span class="p">(</span><span class="n">T_det</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the noise at altitude `alt`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alt : `astropy.units.Quantity`</span>
<span class="sd">            The altitude.</span>
<span class="sd">        return_avg : bool, optional</span>
<span class="sd">            If True, return the value integrated for the passband.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># noise calculations</span>
        <span class="c1"># strategy is to do this for each frequency bin and then do a</span>
        <span class="c1"># weighted average across the band.  This is copied directly from</span>
        <span class="c1"># Sean&#39;s python code.</span>
        <span class="n">T_det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_T_det</span><span class="p">(</span><span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dnep_phot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_to_dnep</span><span class="p">(</span><span class="n">T_det</span><span class="p">)</span>

        <span class="c1"># detector noise factor coefficient</span>
        <span class="n">det_noise_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_params</span><span class="p">[</span><span class="s1">&#39;det_noise_factor&#39;</span><span class="p">])</span>

        <span class="n">dnep</span> <span class="o">=</span> <span class="n">dnep_phot</span> <span class="o">*</span> <span class="n">det_noise_coeff</span>

        <span class="c1"># atm transmission</span>
        <span class="n">tx_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tx_atm</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
        <span class="c1"># the equivalent noise in astronomical units</span>
        <span class="n">dnet_cmb</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_T_to_dnet_cmb</span><span class="p">(</span><span class="n">T_det</span><span class="p">,</span> <span class="n">tx_atm</span><span class="o">=</span><span class="n">tx_atm</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">det_noise_coeff</span>
                <span class="p">)</span>
        <span class="n">dnefd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dnep_to_dnefd</span><span class="p">(</span><span class="n">dnep</span><span class="p">,</span> <span class="n">tx_atm</span><span class="o">=</span><span class="n">tx_atm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_avg</span><span class="p">:</span>
            <span class="c1"># integrate these up</span>
            <span class="n">net_cmb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">dnet_cmb</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">nefd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">dnefd</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># nep is sum of squares</span>
            <span class="n">nep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">dnep</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># power just adds</span>
            <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;net_cmb&#39;</span><span class="p">:</span> <span class="n">net_cmb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mK</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="s1">&#39;nefd&#39;</span><span class="p">:</span> <span class="n">nefd</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mJy</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="s1">&#39;nep&#39;</span><span class="p">:</span> <span class="n">nep</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">aW</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;dnet_cmb&#39;</span><span class="p">:</span> <span class="n">net_cmb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mK</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="s1">&#39;dnefd&#39;</span><span class="p">:</span> <span class="n">nefd</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mJy</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="s1">&#39;dnep&#39;</span><span class="p">:</span> <span class="n">nep</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">aW</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">make_summary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a summary for a list of altitudes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="p">[</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">,</span> <span class="mf">70.</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_noise</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
        <span class="n">nep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_noise</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">return_avg</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;nep&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">nep</span>


<span class="k">class</span> <span class="nc">ToltecObsSimulator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that make simulated observations for TolTEC.</span>

<span class="sd">    The simulator makes use of a suite of models::</span>

<span class="sd">                        telescope pointing (lon, lat)</span>
<span class="sd">                                                |</span>
<span class="sd">                                                v</span>
<span class="sd">        detectors positions (x, y) -&gt; [SkyProjectionModel]</span>
<span class="sd">                                                |</span>
<span class="sd">                                                v</span>
<span class="sd">                            projected detectors positions (lon, lat)</span>
<span class="sd">                                                |</span>
<span class="sd">         sky/atmosphere model (lon, lat flux) -&gt;|</span>
<span class="sd">                                                v</span>
<span class="sd">        source catalogs (lon, lat, flux) -&gt; [BeamModel]</span>
<span class="sd">                                                |</span>
<span class="sd">                            [filter passband] -&gt;|</span>
<span class="sd">                                                v</span>
<span class="sd">                                        detector loading (pwr)</span>
<span class="sd">                                                |</span>
<span class="sd">                                                v</span>
<span class="sd">                                           [KidsProbeModel]</span>
<span class="sd">                                                |</span>
<span class="sd">                                                v</span>
<span class="sd">                                detector raw readout (I, Q)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array_prop_table: astropy.table.Table</span>
<span class="sd">        The array property table that contains all necessary information</span>
<span class="sd">        for the detectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># these are generated from Grant&#39;s Mapping-Speed-Calculator code</span>
    <span class="c1"># The below is for elev 45 deg, atm 25 quantiles</span>
    <span class="n">array_optical_props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a1100&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="mf">10.01</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;bkg_temp&#39;</span><span class="p">:</span> <span class="mf">9.64</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;responsivity&#39;</span><span class="p">:</span> <span class="mf">5.794e-5</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;passband&#39;</span><span class="p">:</span> <span class="mi">65</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="s1">&#39;a1400&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="mf">7.15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;bkg_temp&#39;</span><span class="p">:</span> <span class="mf">9.43</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;responsivity&#39;</span><span class="p">:</span> <span class="mf">1.1e-4</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;passband&#39;</span><span class="p">:</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="s1">&#39;a2000&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="mf">5.29</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;bkg_temp&#39;</span><span class="p">:</span> <span class="mf">8.34</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;responsivity&#39;</span><span class="p">:</span> <span class="mf">1.1e-4</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">,</span>
            <span class="s1">&#39;passband&#39;</span><span class="p">:</span> <span class="mi">42</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="c1"># these are some fiducial kids model params</span>
    <span class="n">kids_props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fp&#39;</span><span class="p">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>  <span class="c1"># column name of apt if string</span>
        <span class="s1">&#39;fr&#39;</span><span class="p">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Qr&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
        <span class="s1">&#39;g0&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;g1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;phi_g&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;f0&#39;</span><span class="p">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
        <span class="s1">&#39;k0&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span>
        <span class="s1">&#39;k1&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span>
        <span class="s1">&#39;m0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;m1&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
    <span class="n">readout_model_cls</span> <span class="o">=</span> <span class="n">ReadoutGainWithLinTrend</span>
    <span class="n">beam_model_cls</span> <span class="o">=</span> <span class="n">BeamModel</span>
    <span class="n">erfa_interp_len</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="n">_observer</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s1">&#39;observer&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">observer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observer</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_prop_table</span><span class="p">):</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_table</span><span class="p">(</span><span class="n">array_prop_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_model_cls</span><span class="p">()</span>

        <span class="c1"># create the simulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kidssim</span> <span class="o">=</span> <span class="n">KidsSimulator</span><span class="p">(</span>
                <span class="n">fr</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">],</span>
                <span class="n">Qr</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;Qr&#39;</span><span class="p">],</span>
                <span class="n">background</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
                <span class="n">responsivity</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;responsivity&#39;</span><span class="p">])</span>
        <span class="c1"># create the gain model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readout_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readout_model_cls</span><span class="p">(</span>
                <span class="n">n_models</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">c</span><span class="p">:</span> <span class="n">tbl</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s1">&#39;g0&#39;</span><span class="p">,</span> <span class="s1">&#39;g1&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_g&#39;</span><span class="p">,</span> <span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="s1">&#39;k0&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;m0&#39;</span><span class="p">,</span> <span class="s1">&#39;m1&#39;</span><span class="p">]</span>
                    <span class="p">},</span>
                <span class="p">)</span>
        <span class="c1"># get detector position on the sky in the toltec frame</span>
        <span class="n">x_a</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span>
        <span class="n">y_a</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span>
        <span class="n">x_t</span><span class="p">,</span> <span class="n">y_t</span> <span class="o">=</span> <span class="n">ArrayProjModel</span><span class="p">()(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">],</span> <span class="n">x_a</span><span class="p">,</span> <span class="n">y_a</span><span class="p">)</span>
        <span class="n">tbl</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x_t&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">x_t</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
        <span class="n">tbl</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">y_t</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_t&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">y_t</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_sky_projection_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the model that project TolTEC detectors on the sky.&quot;&quot;&quot;</span>
        <span class="n">m_proj</span> <span class="o">=</span> <span class="n">SkyProjModel</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m_proj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kidssim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kidssim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kids_readout_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readout_model</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">probe_context</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">f_smp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a function that can be used to get IQ for given flux.</span>

<span class="sd">        When `with_array_loading` is True, the generated power loading</span>
<span class="sd">        will be the sum of the contribution from the astronomical source</span>
<span class="sd">        and the telescope and atmosphere:</span>

<span class="sd">            P_tot = P_src + P_bkg_fixture + P_atm(alt)</span>

<span class="sd">        We set the tune of the KidsSimulator,</span>
<span class="sd">        such that x=0 at P=P_bkg_fixture + P_atm(alt_of_tune_obs).</span>

<span class="sd">        Thus the measured detuning parameters is proportional to</span>

<span class="sd">            P_src + (P_atm(alt) - P_atm(alt_of_tune_obs))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
        <span class="c1"># make a copy here because</span>
        <span class="c1"># we&#39;ll adjust the bkg</span>
        <span class="n">kidssim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kidssim</span>
        <span class="n">readout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readout_model</span>
        <span class="k">if</span> <span class="n">fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">_fr</span>
        <span class="c1"># check the sources for array loading model</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="n">ArrayLoadingModel</span><span class="p">):</span>
                    <span class="n">array_loading_model</span> <span class="o">=</span> <span class="n">source</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array_loading_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">array_loading_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;evaluate array loading model: </span><span class="si">{</span><span class="n">array_loading_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">array_loading_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the loading model is per-array</span>
            <span class="c1"># this holds the power at which x=0</span>
            <span class="c1"># this has to be a constant for all evaluate calls</span>
            <span class="n">p_tune</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">alm</span> <span class="ow">in</span> <span class="n">array_loading_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;need altitudes to evaluate array loading model&quot;</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">_evaluate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">wl_center</span><span class="p">,</span> <span class="n">pb_width</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">alm</span><span class="p">):</span>
                    <span class="c1"># per-array eval</span>
                    <span class="c1"># we also need to ravel s and alt so that they become</span>
                    <span class="c1"># 1d</span>
                    <span class="c1"># brightness temperature</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;evaluate loading model name=</span><span class="si">{</span><span class="n">alm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">tbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                                <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span>
                                    <span class="n">wl_center</span><span class="p">)))</span>
                    <span class="n">pwrs</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">tbs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
                            <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">temperature_energy</span><span class="p">())</span>
                        <span class="o">*</span> <span class="n">pb_width</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                    <span class="c1"># note that we cannot afford</span>
                    <span class="c1"># doing this for each frequency bin.</span>
                    <span class="c1"># we&#39;ll just assume a square passband with width=df</span>
                    <span class="c1"># overall sys_eff</span>
                    <span class="n">sys_eff</span> <span class="o">=</span> <span class="n">alm</span><span class="o">.</span><span class="n">_wsum</span><span class="p">(</span>
                            <span class="n">alm</span><span class="o">.</span><span class="n">_system_efficiency</span><span class="p">,</span> <span class="n">alm</span><span class="o">.</span><span class="n">_throughput</span>
                            <span class="p">)</span>
                    <span class="n">pwrs</span> <span class="o">=</span> <span class="n">pwrs</span> <span class="o">*</span> <span class="n">sys_eff</span>

                    <span class="c1"># add the loading temperate from non astro source</span>
                    <span class="n">alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
                    <span class="c1"># again, this is too slow to do for each sample,</span>
                    <span class="c1"># we&#39;ll just use interpolation.</span>
                    <span class="n">alt_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
                    <span class="n">alt_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
                    <span class="n">alt_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">alt_min</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                            <span class="n">alt_max</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="mf">0.1</span>
                            <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="c1"># make sure we have enough elevation points</span>
                        <span class="n">alt_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                            <span class="n">alt_min</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                            <span class="n">alt_max</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                            <span class="mi">10</span>
                            <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                    <span class="n">p_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                            <span class="n">alt_grid</span><span class="p">,</span> <span class="n">alm</span><span class="o">.</span><span class="n">_get_P</span><span class="p">(</span><span class="n">alt_grid</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">),</span>
                            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span>
                            <span class="p">)</span>
                    <span class="n">dp_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                            <span class="n">alt_grid</span><span class="p">,</span>
                            <span class="p">(</span>
                                <span class="n">alm</span><span class="o">.</span><span class="n">_get_noise</span><span class="p">(</span><span class="n">alt_grid</span><span class="p">)[</span><span class="s1">&#39;nep&#39;</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f_smp</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">),</span>
                            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span>
                            <span class="p">)</span>

                    <span class="n">pwrs_non_src</span> <span class="o">=</span> <span class="n">p_interp</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span>
                    <span class="n">dpwr</span> <span class="o">=</span> <span class="n">dp_interp</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
                    <span class="n">dpwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dpwr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span>
                    <span class="c1"># print(np.min(pwrs), np.max(pwrs))</span>
                    <span class="c1"># print(np.min(pwrs_non_src), np.max(pwrs_non_src))</span>
                    <span class="c1"># print(np.min(dpwr), np.max(dpwr))</span>
                    <span class="c1"># import matplotlib.pyplot as plt</span>
                    <span class="c1"># fig, axes = plt.subplots(3, 1, constrained_layout=True)</span>
                    <span class="c1"># axes[0].imshow(pwrs.reshape(s.shape))</span>
                    <span class="c1"># axes[1].imshow(pwrs_non_src.reshape(s.shape))</span>
                    <span class="c1"># axes[2].imshow(dpwr.reshape(s.shape))</span>
                    <span class="c1"># plt.show()</span>
                    <span class="c1"># make a realization of the pwrs</span>
                    <span class="n">pwrs</span> <span class="o">=</span> <span class="n">pwrs</span> <span class="o">+</span> <span class="n">pwrs_non_src</span> <span class="o">+</span> <span class="n">dpwr</span>
                    <span class="k">return</span> <span class="n">pwrs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># the alm has to be evaluated on a per array basis</span>
                <span class="n">pwrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="c1"># adjust the bkg</span>
                <span class="n">_kidssim</span> <span class="o">=</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">alm</span> <span class="ow">in</span> <span class="n">array_loading_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">array_name</span>
                    <span class="k">if</span> <span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># take the mean of  alt as the tune position</span>
                        <span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alm</span><span class="o">.</span><span class="n">_get_P</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alt</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;set P_tune[</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;use P_tune[</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calc array loading for </span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">pwrs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_evaluate</span><span class="p">(</span>
                            <span class="n">s</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">wl_center</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">pb_width</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;passband&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alm</span><span class="o">=</span><span class="n">alm</span><span class="p">,</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                    <span class="n">_kidssim</span><span class="o">.</span><span class="n">_background</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span>
                <span class="n">pwrs</span> <span class="o">=</span> <span class="n">pwrs</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span>
                <span class="n">rs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">iqs</span> <span class="o">=</span> <span class="n">_kidssim</span><span class="o">.</span><span class="n">probe_p</span><span class="p">(</span>
                        <span class="n">pwrs</span><span class="p">,</span>
                        <span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">readout_model</span><span class="o">=</span><span class="n">readout</span><span class="p">)</span>
                <span class="c1"># compute the flxscale</span>
                <span class="n">pwr_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
                <span class="k">for</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">alm</span> <span class="ow">in</span> <span class="n">array_loading_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">array_name</span>
                    <span class="n">wl_center</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;wl_center&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pb_width</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;passband&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                            <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span>
                                <span class="n">wl_center</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="n">pwr</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">tb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
                                <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">temperature_energy</span><span class="p">())</span>
                            <span class="o">*</span> <span class="n">pb_width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                    <span class="n">sys_eff</span> <span class="o">=</span> <span class="n">alm</span><span class="o">.</span><span class="n">_wsum</span><span class="p">(</span>
                            <span class="n">alm</span><span class="o">.</span><span class="n">_system_efficiency</span><span class="p">,</span> <span class="n">alm</span><span class="o">.</span><span class="n">_throughput</span>
                            <span class="p">)</span>
                    <span class="n">pwr_norm</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">pwr</span> <span class="o">*</span> <span class="n">sys_eff</span> <span class="o">+</span> <span class="n">p_tune</span><span class="p">[</span><span class="n">array_name</span><span class="p">])</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                <span class="n">pwr_norm</span> <span class="o">=</span> <span class="n">pwr_norm</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">pW</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">x_norm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_kidssim</span><span class="o">.</span><span class="n">probe_p</span><span class="p">(</span>
                        <span class="n">pwr_norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">readout_model</span><span class="o">=</span><span class="n">readout</span><span class="p">)</span>
                <span class="n">flxscale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_norm</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flxscale: </span><span class="si">{</span><span class="n">flxscale</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">iqs</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># when loading model is not specified, we just use</span>
            <span class="c1"># the pre-defined values.</span>
            <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="c1"># convert to brightness temperature and</span>
                <span class="c1"># assuming a square pass band, we can get the power loading</span>
                <span class="c1"># TODO use the real passbands.</span>
                <span class="n">tbs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                        <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                        <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;wl_center&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
                <span class="n">pwrs</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">tbs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
                            <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">temperature_energy</span><span class="p">())</span>
                        <span class="o">*</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;passband&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                <span class="n">rs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">iqs</span> <span class="o">=</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">probe_p</span><span class="p">(</span>
                        <span class="n">pwrs</span> <span class="o">+</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">readout_model</span><span class="o">=</span><span class="n">readout</span><span class="p">)</span>
                <span class="c1"># compute flxscale</span>
                <span class="n">pwr_norm</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                                <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;wl_center&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                                    <span class="n">u</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
                                    <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">temperature_energy</span><span class="p">())</span>
                                <span class="o">*</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;passband&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pW</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">x_norm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">probe_p</span><span class="p">(</span>
                        <span class="n">pwr_norm</span> <span class="o">+</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">readout_model</span><span class="o">=</span><span class="n">readout</span><span class="p">)</span>
                <span class="n">flxscale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_norm</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flxscale: </span><span class="si">{</span><span class="n">flxscale</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">iqs</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">evaluate</span>

    <span class="nd">@timeit</span>
    <span class="k">def</span> <span class="nf">resolve_sky_map_ref_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_frame</span><span class="p">,</span> <span class="n">time_obs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_resolve_sky_map_ref_frame</span><span class="p">(</span>
                    <span class="n">ref_frame</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">mapping_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a function that can be used to get</span>
<span class="sd">        input flux at each detector for given time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mapping : tolteca.simu.base.SkyMapModel</span>

<span class="sd">            The model that defines the on-the-fly mapping trajectory.</span>

<span class="sd">        sources : tolteca.simu.base.SourceModel</span>

<span class="sd">            The list of models that define the input signal and noise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;x_t&#39;</span><span class="p">]</span>
        <span class="n">y_t</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;y_t&#39;</span><span class="p">]</span>

        <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">target</span>
        <span class="n">ref_frame</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">ref_frame</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">t0</span>

        <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">erfa_astrom</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ErfaAstromInterpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erfa_interp_len</span><span class="p">)):</span>
                <span class="n">time_obs</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">t</span>
                <span class="c1"># transform ref_coord to ref_frame</span>
                <span class="c1"># need to re-set altaz frame with frame attrs</span>
                <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;transform bore sight coords to projected frame&quot;</span><span class="p">):</span>
                    <span class="n">_ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_sky_map_ref_frame</span><span class="p">(</span>
                            <span class="n">ref_frame</span><span class="p">,</span> <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;transform ref coords to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">time_obs</span><span class="p">)</span><span class="si">}</span><span class="s1"> times&#39;</span><span class="p">):</span>
                        <span class="n">_ref_coord</span> <span class="o">=</span> <span class="n">ref_coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">_ref_frame</span><span class="p">)</span>
                    <span class="n">obs_coords</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">_ref_coord</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="n">hold_flags</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">evaluate_holdflag</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">m_proj_icrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sky_projection_model</span><span class="p">(</span>
                            <span class="n">ref_coord</span><span class="o">=</span><span class="n">obs_coords</span><span class="p">,</span>
                            <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">,</span>
                            <span class="n">evaluate_frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="n">m_proj_native</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sky_projection_model</span><span class="p">(</span>
                            <span class="n">ref_coord</span><span class="o">=</span><span class="n">obs_coords</span><span class="p">,</span>
                            <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">,</span>
                            <span class="n">evaluate_frame</span><span class="o">=</span><span class="s1">&#39;native&#39;</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="n">projected_frame</span><span class="p">,</span> <span class="n">native_frame</span> <span class="o">=</span> \
                        <span class="n">m_proj_icrs</span><span class="o">.</span><span class="n">get_projected_frame</span><span class="p">(</span>
                            <span class="n">also_return_native_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># there is weird cache issue so we cannot</span>
                    <span class="c1"># just do the transform easily</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obs_coords</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">):</span>  <span class="c1"># icrs</span>
                        <span class="n">obs_coords_icrs</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                <span class="n">obs_coords</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs_coords</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                                <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span>
                                <span class="p">)</span>
                        <span class="n">_altaz_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_sky_map_ref_frame</span><span class="p">(</span>
                                <span class="s1">&#39;altaz&#39;</span><span class="p">,</span> <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">)</span>
                        <span class="n">obs_coords_altaz</span> <span class="o">=</span> <span class="n">obs_coords_icrs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
                                <span class="n">_altaz_frame</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obs_coords</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">):</span>  <span class="c1"># altaz</span>
                        <span class="n">obs_coords_icrs</span> <span class="o">=</span> <span class="n">obs_coords</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
                        <span class="n">obs_coords_altaz</span> <span class="o">=</span> <span class="n">obs_coords</span>
                    <span class="n">obs_parallactic_angle</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">parallactic_angle</span><span class="p">(</span>
                                <span class="n">time_obs</span><span class="p">,</span> <span class="n">obs_coords_icrs</span><span class="p">)</span>

                <span class="c1"># get detector positions, which requires absolute time</span>
                <span class="c1"># to get the altaz to equatorial transformation</span>

                <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;transform det coords to projected frame&quot;</span><span class="p">):</span>
                    <span class="c1"># this has to take into account</span>
                    <span class="c1"># the rotation of det coord by alt due to M3</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">obs_coords_altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">radian</span>
                    <span class="n">m_rot_m3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
                        <span class="p">])</span>
                    <span class="c1"># there should be more clever way of this but for now</span>
                    <span class="c1"># we just spell out the rotation</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">m_rot_m3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> \
                        <span class="o">+</span> <span class="n">m_rot_m3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">m_rot_m3</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> \
                        <span class="o">+</span> <span class="n">m_rot_m3</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">m_proj_icrs</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_interp_len</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">az</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">m_proj_native</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_interp_len</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

                <span class="c1"># combine the array projection with sky projection</span>
                <span class="c1"># and evaluate with source frame</span>
                <span class="n">s_additive</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">m_source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m_source</span><span class="p">,</span> <span class="n">SourceCatalogModel</span><span class="p">):</span>
                        <span class="n">m_source</span> <span class="o">=</span> <span class="n">m_source</span><span class="o">.</span><span class="n">make_image_model</span><span class="p">(</span>
                                <span class="n">beam_models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_m_beam</span><span class="o">.</span><span class="n">models</span><span class="p">,</span>
                                <span class="n">pixscale</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>
                                <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m_source</span><span class="p">,</span> <span class="n">SourceImageModel</span><span class="p">):</span>
                        <span class="c1"># TODO support more types of wcs. For now</span>
                        <span class="c1"># only ICRS is supported</span>
                        <span class="c1"># the projected lon lat</span>
                        <span class="c1"># extract the flux</span>
                        <span class="c1"># detector is required to be the first dimension</span>
                        <span class="c1"># for the evaluate_tod</span>
                        <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;extract flux from source image&quot;</span><span class="p">):</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">m_source</span><span class="o">.</span><span class="n">evaluate_tod</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="n">s_additive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="c1"># TODO revisit the performance issue here</span>
                    <span class="k">elif</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m_source</span><span class="p">,</span> <span class="n">SourceCatalogModel</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;transform src coords to projected frame&quot;</span><span class="p">):</span>
                            <span class="n">src_pos</span> <span class="o">=</span> <span class="n">m_source</span><span class="o">.</span><span class="n">pos</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
                                        <span class="n">native_frame</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
                                            <span class="n">projected_frame</span><span class="p">)</span>
                        <span class="c1"># evaluate with beam_model and reduce on sources axes</span>
                        <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;convolve with beam&quot;</span><span class="p">):</span>
                            <span class="n">dx</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> \
                                <span class="n">src_pos</span><span class="o">.</span><span class="n">lon</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                            <span class="n">dy</span> <span class="o">=</span> <span class="n">y_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> \
                                <span class="n">src_pos</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                            <span class="n">an</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">],</span>
                                        <span class="n">src_pos</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)),</span>
                                    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_beam</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
                            <span class="c1"># weighted sum with flux at each detector</span>
                            <span class="c1"># assume no polarization</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
                                <span class="n">m_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">w</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">s_additive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_additive</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no additive source found in source list&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">s_additive</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">evaluate</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">obs_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_model</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">ref_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a function that can be used to get</span>
<span class="sd">        input flux at each detector for given time.&quot;&quot;&quot;</span>
        <span class="n">m_obs</span> <span class="o">=</span> <span class="n">obs_model</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;x_t&#39;</span><span class="p">]</span>
        <span class="n">y_t</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;y_t&#39;</span><span class="p">]</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO: implement handling of other source model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="p">(</span><span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">ref_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># define a field center</span>
            <span class="c1"># here we use the first object in the sources catalog</span>
            <span class="c1"># and realize the obs pattern around this center</span>
            <span class="c1"># we need to take into acount the ref_frame and</span>
            <span class="c1"># prepare ref_coord such that it is in the ref_frame</span>
            <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

            <span class="n">time_obs</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">t</span>

            <span class="c1"># transform ref_coord to ref_frame</span>
            <span class="c1"># need to re-set altaz frame with frame attrs</span>
            <span class="n">_ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_sky_map_ref_frame</span><span class="p">(</span>
                    <span class="n">ref_frame</span><span class="p">,</span> <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span><span class="p">)</span>
            <span class="n">_ref_coord</span> <span class="o">=</span> <span class="n">ref_coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">_ref_frame</span><span class="p">)</span>
            <span class="n">obs_coords</span> <span class="o">=</span> <span class="n">m_obs</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">_ref_coord</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="c1"># get detector positions, which requires absolute time</span>
            <span class="c1"># to get the altaz to equatorial transformation</span>
            <span class="c1"># here we only project in alt az, and we transform the source coord</span>
            <span class="c1"># to alt az for faster computation.</span>

            <span class="c1"># combine the array projection with sky projection</span>
            <span class="n">m_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sky_projection_model</span><span class="p">(</span>
                    <span class="n">ref_coord</span><span class="o">=</span><span class="n">obs_coords</span><span class="p">,</span>
                    <span class="n">time_obs</span><span class="o">=</span><span class="n">time_obs</span>
                    <span class="p">)</span>
            <span class="c1"># logger.debug(f&quot;proj model:\n{m_proj}&quot;)</span>

            <span class="n">projected_frame</span><span class="p">,</span> <span class="n">native_frame</span> <span class="o">=</span> <span class="n">m_proj</span><span class="o">.</span><span class="n">get_projected_frame</span><span class="p">(</span>
                <span class="n">also_return_native_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># transform the sources on to the projected frame this has to be</span>
            <span class="c1"># done in two steps due to limitation in astropy</span>
            <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;transform src coords to projected frame&quot;</span><span class="p">):</span>
                <span class="n">src_coords</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                    <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
                            <span class="n">native_frame</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
                                <span class="n">projected_frame</span><span class="p">)</span>
            <span class="c1"># evaluate with beam_model and reduce on sources axes</span>
            <span class="k">with</span> <span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;compute detector pwr loading&quot;</span><span class="p">):</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">src_coords</span><span class="o">.</span><span class="n">lon</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">y_t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">src_coords</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">an</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">],</span> <span class="n">src_coords</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)),</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_beam</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
                <span class="c1"># weighted sum with flux at each detector</span>
                <span class="c1"># assume no polarization</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;flux_a1100&#39;</span><span class="p">][</span>
                            <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># transform all obs_coords to equitorial</span>
            <span class="n">obs_coords_icrs</span> <span class="o">=</span> <span class="n">obs_coords</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">evaluate</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_prepare_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
        <span class="c1"># make columns for additional array properties to be used</span>
        <span class="c1"># for the kids simulator</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">meta_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wl_center&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="c1"># array props</span>
        <span class="k">for</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;array_names&#39;</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">array_name</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">array_optical_props</span><span class="p">[</span><span class="n">array_name</span><span class="p">],</span>
                    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">array_name</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">meta_keys</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">props</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
                <span class="n">tbl</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># kids props</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">kids_props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">tbl</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">tbl</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                        <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),),</span> <span class="n">value</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid kids prop&#39;</span><span class="p">)</span>
        <span class="c1"># calibration factor</span>
        <span class="c1"># TODO need to revisit these assumptions</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;flxscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;responsivity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">QTable</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">KidsReadoutNoiseModel</span><span class="p">(</span><span class="n">_Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A model of the TolTEC KIDs readout noise.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2021, Zhiyuan Ma.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.0.2. &nbsp;
    Last built 18 Jun 2021. <br/>
  </p>
</footer>
  </body>
</html>