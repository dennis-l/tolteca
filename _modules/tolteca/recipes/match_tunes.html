
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>tolteca.recipes.match_tunes &#8212; tolteca v0.1.dev84+gfc9946a.d20200423</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">TolTECA</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">tolteca v0.1.dev84+gfc9946a.d20200423</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tolteca.recipes.match_tunes</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="c1"># Author:</span>
<span class="c1">#   Zhiyuan Ma</span>

<span class="sd">&quot;&quot;&quot;This recipe helps match the tones in two tune files.</span>

<span class="sd">The code requires an external tool `stilts` to match the tones in</span>
<span class="sd">different files. This code will try download it automatically if not</span>
<span class="sd">already installed. Please refer to http://www.star.bris.ac.uk/~mbt/stilts/</span>
<span class="sd">for more information.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">tolteca.recipes</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">tolteca.fs.toltec</span> <span class="kn">import</span> <span class="n">ToltecDataset</span>
<span class="kn">from</span> <span class="nn">tollan.utils.wraps.stilts</span> <span class="kn">import</span> <span class="n">stilts_match1d</span>
<span class="kn">from</span> <span class="nn">tollan.utils.cli.multi_action_argparser</span> <span class="kn">import</span> \
        <span class="n">MultiActionArgumentParser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tollan.utils.mpl</span> <span class="kn">import</span> <span class="n">save_or_show</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">vstack</span>


<span class="k">def</span> <span class="nf">_calc_d21_worker</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">swp</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">swp</span><span class="o">.</span><span class="n">d21</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="prepare_d21_data"><a class="viewcode-back" href="../../../api/tolteca.recipes.match_tunes.prepare_d21_data.html#tolteca.recipes.match_tunes.prepare_d21_data">[docs]</a><span class="k">def</span> <span class="nf">prepare_d21_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare the dataset for tone match.&quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load tones data from: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># split the dataset for tunes and reduced files</span>
    <span class="n">targs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;(kindstr==&quot;targsweep&quot;) | (kindstr==&quot;tune&quot;)&#39;</span><span class="p">)</span>
    <span class="n">calibs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;fileext==&quot;txt&quot;&#39;</span><span class="p">)</span>
    <span class="c1"># Read the sweep object from the file IO object. A TolTEC tune file</span>
    <span class="c1"># contains multipe sweep blocks, and here we read the last one using the</span>
    <span class="c1"># `sweeploc` method.</span>
    <span class="n">targs</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">fo</span><span class="p">:</span> <span class="n">fo</span><span class="o">.</span><span class="n">sweeploc</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:]</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">join_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nwid&#39;</span><span class="p">,</span> <span class="s1">&#39;obsid&#39;</span><span class="p">,</span> <span class="s1">&#39;subobsid&#39;</span><span class="p">,</span> <span class="s1">&#39;scanid&#39;</span><span class="p">]</span>
    <span class="n">targs</span> <span class="o">=</span> <span class="n">targs</span><span class="o">.</span><span class="n">right_join</span><span class="p">(</span>
            <span class="n">calibs</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fo</span><span class="p">:</span> <span class="n">fo</span><span class="p">),</span>
            <span class="n">join_keys</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;data_obj&#39;</span><span class="p">,</span> <span class="s1">&#39;mdl_obj&#39;</span><span class="p">),</span> <span class="p">],</span> <span class="p">)</span>
    <span class="c1"># join the mdls to swps</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;targs: </span><span class="si">{</span><span class="n">targs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the D21</span>
    <span class="n">d21_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fstep</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">flim</span><span class="o">=</span><span class="p">(</span><span class="mf">4.0e8</span><span class="p">,</span> <span class="mf">1.0e9</span><span class="p">),</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">swps</span> <span class="o">=</span> <span class="n">targs</span><span class="o">.</span><span class="n">data_objs</span>

    <span class="kn">import</span> <span class="nn">psutil</span>
    <span class="kn">import</span> <span class="nn">concurrent</span>
    <span class="n">max_workers</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d21</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">_calc_d21_worker</span><span class="p">,</span> <span class="o">**</span><span class="n">d21_kwargs</span><span class="p">),</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">swps</span><span class="p">)):</span>
            <span class="n">swps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_d21</span> <span class="o">=</span> <span class="n">d21</span>
    <span class="n">targs</span><span class="o">.</span><span class="n">index_table</span><span class="p">[</span><span class="s1">&#39;data_obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swps</span>
    <span class="k">return</span> <span class="n">targs</span></div>


<span class="k">def</span> <span class="nf">_match_d21</span><span class="p">(</span><span class="n">d21_0</span><span class="p">,</span> <span class="n">d21_1</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_locals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given two D21 spectrum, use correlation to find the relative</span>
<span class="sd">    frequency shift between them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d21_0, d21_1: D21</span>
<span class="sd">        The D21s to match.</span>
<span class="sd">    roi: callable, optional</span>
<span class="sd">        If given, this will be used to filter the frequency as ``fs =</span>
<span class="sd">        roi(fs)``.</span>
<span class="sd">    return_locals: bool</span>
<span class="sd">        If set, the ``locals()`` is returned for further diagnostics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float:</span>
<span class="sd">        The relative frequency shift.</span>
<span class="sd">    dict: optional</span>
<span class="sd">        The ``locals()`` dict, if `return_locals` is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">fs0</span><span class="p">,</span> <span class="n">adiqs0</span><span class="p">,</span> <span class="n">adiqscov0</span><span class="p">),</span> <span class="p">(</span><span class="n">fs1</span><span class="p">,</span> <span class="n">adiqs1</span><span class="p">,</span> <span class="n">adiqscov1</span><span class="p">)</span> <span class="o">=</span> <span class="n">d21_0</span><span class="p">,</span> <span class="n">d21_1</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">fs0</span> <span class="o">-</span> <span class="n">fs1</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;find shift only works with same fs grid&quot;</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">fs0</span>
    <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">roi</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">adiqs0</span> <span class="o">=</span> <span class="n">adiqs0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">adiqscov0</span> <span class="o">=</span> <span class="n">adiqscov0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">adiqs1</span> <span class="o">=</span> <span class="n">adiqs1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">adiqscov1</span> <span class="o">=</span> <span class="n">adiqscov1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">correlate</span>
    <span class="n">nfs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">cross_correlation</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">adiqs0</span><span class="p">,</span> <span class="n">adiqs1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">nfs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nfs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># print(dfs.shape)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="n">dfs</span><span class="p">[</span><span class="n">cross_correlation</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">return_locals</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">shift</span>


<div class="viewcode-block" id="find_global_shift"><a class="viewcode-back" href="../../../api/tolteca.recipes.match_tunes.find_global_shift.html#tolteca.recipes.match_tunes.find_global_shift">[docs]</a><span class="k">def</span> <span class="nf">find_global_shift</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span> <span class="n">pairing</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a set of tune files, try find the relative shift of the</span>
<span class="sd">    resonance frequencies of all detectors among them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset: ToltecDataset</span>
<span class="sd">        The dataset to use.</span>

<span class="sd">    pairing: choose from [&#39;diff&#39;, &#39;first&#39;]</span>
<span class="sd">        The pairing method. `diff` will match neighbouring tunes, and</span>
<span class="sd">        `first` will match to the first one.</span>

<span class="sd">    roi: dict or object, optional</span>
<span class="sd">        The range of frequencies to match. If dict, the keys shall be query</span>
<span class="sd">        strings to the dataset, and the value shall be a callable that takes</span>
<span class="sd">        the frequency array and compute a mask for it. If not dict, it is</span>
<span class="sd">        equivalent to applying this to all entries. If None, the entire</span>
<span class="sd">        frequency range is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;find tone shift for dataset: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;roi: </span><span class="si">{</span><span class="n">roi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;dataset has to have at lease 2 entries.&quot;</span><span class="p">)</span>

    <span class="c1"># check that all entries are from the same network</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;nwid&#39;</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;dataset shall be from the same network.&quot;</span><span class="p">)</span>

    <span class="n">swps</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_objs</span>

    <span class="n">_roi</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># resolve roi dict</span>
    <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="s1">&#39;obsid&gt;0&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roi</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">_roi</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;each entry can only have one roi&quot;</span><span class="p">)</span>
                    <span class="n">_roi</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">data_objs</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ee</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">roi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># Do the actuall matching</span>
    <span class="k">if</span> <span class="n">pairing</span> <span class="o">==</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">swps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">swps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">elif</span> <span class="n">pairing</span> <span class="o">==</span> <span class="s1">&#39;first&#39;</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">swps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">swps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">swps</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pairing has to be one of &quot;diff&quot; or &quot;first&quot;.&#39;</span><span class="p">)</span>

    <span class="n">shifts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">shifts_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">shift</span><span class="p">,</span> <span class="n">shift_data</span> <span class="o">=</span> <span class="n">_match_d21</span><span class="p">(</span>
                <span class="n">left</span><span class="o">.</span><span class="n">_d21</span><span class="p">,</span>
                <span class="n">right</span><span class="o">.</span><span class="n">_d21</span><span class="p">,</span>
                <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">right</span><span class="p">),</span> <span class="n">return_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">shifts_data</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">shift_data</span><span class="p">)</span>
    <span class="c1"># Update the table with found shift</span>
    <span class="c1"># The shift is defined as self = other + shift</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;tone_match_global_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">other_swp</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">swps</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_global_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_objs</span> <span class="o">==</span> <span class="n">other_swp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span>
                        <span class="s1">&#39;tone_match_idx_self&#39;</span><span class="p">]</span>

    <span class="c1"># add a unique label for self and other</span>
    <span class="k">def</span> <span class="nf">make_uid</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;nwid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;obsid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;subobsid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;scanid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;tone_match_uid_self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">make_uid</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_self&#39;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;tone_match_uid_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">make_uid</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_other&#39;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">n_panels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_panels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">window_type</span> <span class="o">=</span> <span class="s1">&#39;scrollable&#39;</span>
            <span class="n">fig_size</span> <span class="o">=</span> <span class="n">panel_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">window_type</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
            <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_panels</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">n_panels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_panels</span><span class="p">),</span>
                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">fig_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subtitle</span><span class="p">(</span><span class="n">fig_title</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
            <span class="n">shift_data</span> <span class="o">=</span> <span class="n">shifts_data</span><span class="p">[</span><span class="n">right</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axes</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">shift_data</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">]</span>
            <span class="n">adiqs0</span> <span class="o">=</span> <span class="n">shift_data</span><span class="p">[</span><span class="s1">&#39;adiqs0&#39;</span><span class="p">]</span>
            <span class="n">adiqs1</span> <span class="o">=</span> <span class="n">shift_data</span><span class="p">[</span><span class="s1">&#39;adiqs1&#39;</span><span class="p">]</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">shift_data</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">shift</span> <span class="o">==</span> <span class="n">shifts</span><span class="p">[</span><span class="n">right</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># plot shift data</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">adiqs0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">adiqs1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fs</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span>
                    <span class="n">adiqs0</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;shift=</span><span class="si">{</span><span class="n">shift</span><span class="o">/</span><span class="mf">1e3</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">kHz&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

        <span class="n">save_or_show</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span>
                <span class="n">window_type</span><span class="o">=</span><span class="n">window_type</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="n">fig_size</span>
                <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found global shifts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">[[</span>
            <span class="s1">&#39;nwid&#39;</span><span class="p">,</span> <span class="s1">&#39;obsid&#39;</span><span class="p">,</span> <span class="s1">&#39;subobsid&#39;</span><span class="p">,</span> <span class="s1">&#39;scanid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tone_match_idx_self&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tone_match_idx_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tone_match_global_shift&#39;</span><span class="p">]]</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="match_tones"><a class="viewcode-back" href="../../../api/tolteca.recipes.match_tunes.match_tones.html#tolteca.recipes.match_tunes.match_tones">[docs]</a><span class="k">def</span> <span class="nf">match_tones</span><span class="p">(</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">2000.</span><span class="p">,</span> <span class="n">shift_from_right</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
        <span class="n">match_col</span><span class="o">=</span><span class="s1">&#39;fr&#39;</span><span class="p">,</span>
        <span class="n">join_type</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a table with tones matched.</span>

<span class="sd">    This function makes use the ``stilts`` utility.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    left: astropy.Table</span>
<span class="sd">        The left model params table.</span>
<span class="sd">    right: astropy.Table</span>
<span class="sd">        The right model params table.</span>
<span class="sd">    eps: float</span>
<span class="sd">        The error to tolerate in Hz.</span>
<span class="sd">    shift_from_right: float</span>
<span class="sd">        The frequency shift to apply to the right.</span>
<span class="sd">    match_col: str</span>
<span class="sd">        The column to use for the match.</span>
<span class="sd">        Default is the resonance frequency ``fr``.</span>
<span class="sd">    join_type: str</span>
<span class="sd">        Join type to use for the output table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make match column</span>
    <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;match_tones_col&#39;</span>
    <span class="n">idx_col</span> <span class="o">=</span> <span class="s1">&#39;idx&#39;</span>
    <span class="n">_left</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_right</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_left</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">_left</span><span class="p">[</span><span class="n">match_col</span><span class="p">]</span>
    <span class="n">_left</span><span class="p">[</span><span class="n">idx_col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_left</span><span class="p">)))</span>
    <span class="n">_right</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">_right</span><span class="p">[</span><span class="n">match_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_from_right</span>
    <span class="n">_right</span><span class="p">[</span><span class="n">idx_col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_right</span><span class="p">)))</span>
    <span class="n">join</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;all1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;all2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inner&#39;</span><span class="p">:</span> <span class="s1">&#39;1and2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;outer&#39;</span><span class="p">:</span> <span class="s1">&#39;1or2&#39;</span>
            <span class="p">}[</span><span class="n">join_type</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stilts_match1d</span><span class="p">(</span><span class="n">_left</span><span class="p">,</span> <span class="n">_right</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;join=</span><span class="si">{</span><span class="n">join</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;find=best&#39;</span><span class="p">,</span>
        <span class="p">])</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">maap</span> <span class="o">=</span> <span class="n">MultiActionArgumentParser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Match tones in tune files.&quot;</span>
            <span class="p">)</span>
    <span class="n">act_index</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">add_action_parser</span><span class="p">(</span>
            <span class="s1">&#39;index&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Build an index table that have precomputed D21.&quot;</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;files&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The files to use&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--select&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COND&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A selection predicate, e.g.,:&#39;</span>
            <span class="s1">&#39;&quot;(obsid&gt;8900) &amp; (nwid==3) &amp; (fileext==&quot;nc&quot;)&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_FILE&quot;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output filename&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, overwrite the existing index file&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@act_index</span><span class="o">.</span><span class="n">parser_action</span>
    <span class="k">def</span> <span class="nf">index_action</span><span class="p">(</span><span class="n">option</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">option</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;output file </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> exists, use -f to overwrite&quot;</span><span class="p">)</span>
        <span class="c1"># This function is called when `index` is specified in the cmd</span>
        <span class="c1"># Collect the dataset from the command line arguments</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ToltecDataset</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="o">*</span><span class="n">option</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="c1"># Apply any selection filtering</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">)</span><span class="o">.</span><span class="n">open_files</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">open_files</span><span class="p">()</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">prepare_d21_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="c1"># Dump the results.</span>
        <span class="c1"># dataset.write_index_table(</span>
        <span class="c1">#         option.output, overwrite=option.overwrite,</span>
        <span class="c1">#         format=&#39;ascii.commented_header&#39;)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="n">act_run</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">add_action_parser</span><span class="p">(</span>
            <span class="s1">&#39;run&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run match&quot;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--select&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COND&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A selection predicate, e.g.,:&#39;</span>
            <span class="s1">&#39;&quot;(obsid&gt;8900) &amp; (nwid==3) &amp; (fileext==&quot;nc&quot;)&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The input filename, created by the &quot;index&quot; action.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="s2">&quot;--join_type&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Join type to use for the matched result.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--pairing&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Pairing method for making the match.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_FILE&quot;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output filename with matched tones&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, overwrite the existing index file&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--plot&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;generate plot&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@act_run</span><span class="o">.</span><span class="n">parser_action</span>
    <span class="k">def</span> <span class="nf">run_action</span><span class="p">(</span><span class="n">option</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ToltecDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;match tones for </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;select_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">find_global_shift</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># match tones</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_matched_obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_n_matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_sep_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;matched_tones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">j0</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_self&#39;</span><span class="p">]</span>
                <span class="n">j1</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tone_match_idx_other&#39;</span><span class="p">]</span>
                <span class="c1"># self = other + shift</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tone_match_global_shift&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j0</span> <span class="o">==</span> <span class="n">j1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># get the left and right entry</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">j0</span><span class="p">]</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span>
                <span class="n">cal_left</span> <span class="o">=</span> <span class="n">left</span><span class="p">[</span><span class="s1">&#39;mdl_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
                <span class="n">cal_right</span> <span class="o">=</span> <span class="n">right</span><span class="p">[</span><span class="s1">&#39;mdl_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;apply global shift </span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">)</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">match_tones</span><span class="p">(</span>
                        <span class="n">cal_left</span><span class="p">,</span> <span class="n">cal_right</span><span class="p">,</span> <span class="n">shift_from_right</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span>
                        <span class="n">join_type</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">join_type</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">10000.</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_matched_obj&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_n_matched&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_sep_median&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                        <span class="n">matched</span><span class="p">[</span><span class="s1">&#39;Separation&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="n">join_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nwid&#39;</span><span class="p">,</span> <span class="s1">&#39;obsid&#39;</span><span class="p">,</span> <span class="s1">&#39;subobsid&#39;</span><span class="p">,</span> <span class="s1">&#39;scanid&#39;</span><span class="p">]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">left_join</span><span class="p">(</span><span class="n">ToltecDataset</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="n">_match</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;nwid&#39;</span><span class="p">))),</span>
            <span class="n">join_keys</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;tone_match_.*&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_matched_obj&#39;</span><span class="p">]),</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="s1">&#39;subobsid&#39;</span><span class="p">,</span> <span class="s1">&#39;scanid&#39;</span><span class="p">)))</span>

        <span class="c1"># build final matched tone catalogs</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_prep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">t</span><span class="p">[</span><span class="s1">&#39;nwid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nwid&#39;</span><span class="p">],</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">t</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span>
                <span class="n">_prep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;tone_match_matched_obj&#39;</span><span class="p">])</span>
                    <span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;tone_match_uid_self&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tone_match_uid_other&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tone_match_n_matched&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tone_match_sep_median&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tone_match_global_shift&#39;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="k">def</span> <span class="nf">escape_0</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;uid&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;toltec</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="n">tbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">escape_0</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_uid_self&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;tone_match_uid_other&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.asc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.asc&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_matched_</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">.asc&#39;</span><span class="p">)</span>
            <span class="n">tbl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="c1"># plot per obsnum match hist</span>
            <span class="n">n_panels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>  <span class="c1"># the match base is excluded</span>
            <span class="k">if</span> <span class="n">n_panels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">panel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">window_type</span> <span class="o">=</span> <span class="s1">&#39;scrollable&#39;</span>
                <span class="n">fig_size</span> <span class="o">=</span> <span class="n">panel_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">panel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">window_type</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
                <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_panels</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="n">n_panels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_panels</span><span class="p">),</span>
                    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axes</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tone_match_matched_obj&#39;</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;Separation&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;nw=</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;nwid&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
                        <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;obsid=</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obsid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
            <span class="n">save_or_show</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                    <span class="n">window_type</span><span class="o">=</span><span class="n">window_type</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">fig_size</span>
                    <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;write output </span><span class="si">{</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">write_index_table</span><span class="p">(</span>
                <span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="n">exclude_cols</span><span class="o">=</span><span class="s1">&#39;.+_obj&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.commented_header&#39;</span><span class="p">)</span>

    <span class="n">option</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">maap</span><span class="o">.</span><span class="n">bootstrap_actions</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2020, Zhiyuan Ma.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.0.2. &nbsp;
    Last built 23 Apr 2020. <br/>
  </p>
</footer>
  </body>
</html>